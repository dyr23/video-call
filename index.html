<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>精致微缩交互树</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        #canvas-ui { position: absolute; top: 10px; left: 10px; width: 60px; height: 80px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; z-index: 100; transform: scaleX(-1); }
    </style>
</head>
<body>
    <div id="overlay" class="absolute inset-0 z-[200] flex items-center justify-center bg-black">
        <button onclick="start()" class="border border-white/30 text-white px-8 py-3 rounded-md tracking-widest text-sm uppercase">加载精致模式</button>
    </div>

    <div id="status" class="absolute top-10 w-full text-center text-white/40 z-50 text-[10px] tracking-[0.5em] uppercase pointer-events-none">Stable Mode</div>
    <canvas id="canvas-ui"></canvas>
    <video id="input-video" style="display:none"></video>

    <script>
        let scene, camera, renderer, treeGroup, lastX = null;
        let targetRotation = 0;
        let currentRotation = 0;

        function init3D() {
            scene = new THREE.Scene();
            // 增加 FOV 到 60，让物体显得更远更小
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 10); 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 1.5));
            
            treeGroup = new THREE.Group();
            // 【史诗级缩小】从 0.8 砍到 0.45
            treeGroup.scale.set(0.45, 0.45, 0.45); 

            // 树干
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.3, 2), new THREE.MeshPhongMaterial({color: 0x1a110e}));
            treeGroup.add(trunk);

            // 树冠
            for(let i=0; i<4; i++) {
                const leaf = new THREE.Mesh(
                    new THREE.ConeGeometry(2.5 - i*0.5, 2, 12),
                    new THREE.MeshPhongMaterial({color: 0x0a2412, flatShading: true})
                );
                leaf.position.y = 1.5 + (i * 1.2);
                treeGroup.add(leaf);
                addPhoto(leaf.position.y, i);
            }
            scene.add(treeGroup);
        }

        function addPhoto(y, index) {
            const loader = new THREE.TextureLoader();
            const tex = loader.load(`https://picsum.photos/300/400?random=${index + 99}`);
            const photo = new THREE.Mesh(
                new THREE.PlaneGeometry(1.2, 1.6),
                new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide })
            );
            const angle = (index * 1.5);
            const dist = 2.5;
            photo.position.set(Math.cos(angle)*dist, y, Math.sin(angle)*dist);
            photo.lookAt(0, y, 0);
            photo.userData = { isPhoto: true, originalPos: photo.position.clone(), originalRot: photo.rotation.clone() };
            treeGroup.add(photo);
        }

        async function start() {
            document.getElementById('overlay').remove();
            init3D();
            const video = document.getElementById('input-video');
            const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.7});
            
            hands.onResults(res => {
                const canvas = document.getElementById('canvas-ui');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(res.image, 0,0,canvas.width,canvas.height);
                
                if(res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                    const x = res.multiHandLandmarks[0][8].x;
                    if(lastX !== null) {
                        // 【大幅降速】从 35 降到 8，现在会非常稳
                        targetRotation += (x - lastX) * 8; 
                    }
                    lastX = x;
                } else {
                    lastX = null;
                }
            });
            const cam = new Camera(video, {onFrame: async () => {await hands.send({image: video})}, width: 320, height: 240});
            cam.start();
            render();
        }

        function render() {
            requestAnimationFrame(render);
            // 增加阻尼系数，让转动更丝滑沉稳 (0.1 -> 0.05)
            currentRotation += (targetRotation - currentRotation) * 0.05;
            treeGroup.rotation.y = currentRotation;
            renderer.render(scene, camera);
        }

        window.onclick = (e) => {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(treeGroup.children);
            if(intersects.length > 0 && intersects[0].object.userData.isPhoto) {
                const p = intersects[0].object;
                if(p.scale.x === 1) {
                    p.scale.set(3, 3, 3); p.position.set(0, 1.5, 5); p.rotation.set(0,0,0);
                } else {
                    p.scale.set(1, 1, 1); p.position.copy(p.userData.originalPos); p.rotation.copy(p.userData.originalRot);
                }
            }
        };
    </script>
</body>
</html>
