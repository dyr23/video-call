<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圣诞树交互测试</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background: radial-gradient(circle, #001540, #000000); overflow: hidden; }
        #status { position: absolute; top: 20px; width: 100%; text-align: center; color: white; font-family: sans-serif; z-index: 10; }
        #debug-win { position: absolute; bottom: 10px; left: 10px; width: 120px; height: 90px; border: 2px solid #00ff00; z-index: 100; background: #222; }
    </style>
</head>
<body>
    <div id="status">正在加载精致圣诞树...</div>
    <div id="debug-win"><video id="v" style="display:none"></video><canvas id="c" style="width:100%;height:100%;transform:scaleX(-1)"></canvas></div>

    <script>
        // --- 3D 场景初始化 ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 3, 8);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 5, 5);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        // --- 构建精致圣诞树 ---
        const treeGroup = new THREE.Group();
        // 树干
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.3, 1), new THREE.MeshPhongMaterial({color: 0x5D4037}));
        treeGroup.add(trunk);
        // 五层树冠
        for(let i=0; i<5; i++) {
            const leaf = new THREE.Mesh(
                new THREE.ConeGeometry(2 - i*0.35, 1.2, 8),
                new THREE.MeshPhongMaterial({color: 0x2D5A27, flatShading: true})
            );
            leaf.position.y = 1.0 + (i * 0.7);
            treeGroup.add(leaf);
        }
        scene.add(treeGroup);

        // --- 手势控制逻辑 ---
        let lastX = null;
        const video = document.getElementById('v');
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d');

        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5});
        hands.onResults(res => {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(res.image, 0,0,canvas.width,canvas.height);
            if(res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                document.getElementById('status').innerText = "✨ 捕捉到手势，快挥动！ ✨";
                const x = res.multiHandLandmarks[0][8].x;
                if(lastX !== null) { treeGroup.rotation.y += (x - lastX) * 50; }
                lastX = x;
            }
        });

        const cam = new Camera(video, {onFrame: async () => {await hands.send({image: video})}, width: 320, height: 240});
        cam.start().then(() => { document.getElementById('status').innerText = "摄像头已开启，等待手势..."; });

        function render() { requestAnimationFrame(render); renderer.render(scene, camera); }
        render();
        window.onresize = () => { renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); };
    </script>
</body>
</html>
