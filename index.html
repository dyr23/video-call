<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç²¾è‡´äº¤äº’åœ£è¯æ ‘</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: radial-gradient(circle at center, #050a1a 0%, #000 100%); overflow: hidden; }
        #canvas-ui { position: absolute; top: 15px; right: 15px; width: 70px; height: 90px; border: 1px solid rgba(0,255,0,0.5); border-radius: 10px; z-index: 100; transform: scaleX(-1); }
        #overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="overlay" class="absolute inset-0 z-[200] flex items-center justify-center">
        <div class="text-center">
            <div class="text-6xl mb-6">ğŸ„</div>
            <button onclick="start()" class="bg-white text-black px-12 py-4 rounded-full font-bold text-xl shadow-white/20 shadow-2xl active:scale-95 transition-all">å¼€å¯è§†è§‰äº¤äº’</button>
            <p class="text-gray-500 mt-6 text-sm">æˆæƒåè¯·å°†æ‰‹æ”¾ç½®åœ¨è·é•œå¤´50cmå¤„</p>
        </div>
    </div>

    <div id="status" class="absolute top-12 w-full text-center text-white/70 z-50 text-base font-light tracking-widest pointer-events-none"></div>
    <canvas id="canvas-ui"></canvas>
    <video id="input-video" style="display:none"></video>

    <script>
        let scene, camera, renderer, treeGroup, lastX = null;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
            // è°ƒæ•´ç›¸æœºä½ç½®ï¼Œè®©æ ‘åˆšå¥½å±…ä¸­
            camera.position.set(0, 2, 7); 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
            
            treeGroup = new THREE.Group();
            // ç¼©å°ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å…¶å®Œç¾é€‚é…æ‰‹æœºå±å¹•
            treeGroup.scale.set(1.2, 1.2, 1.2); 

            // 1. æ ‘å¹²
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.2, 1.2), new THREE.MeshPhongMaterial({color: 0x3d251e}));
            treeGroup.add(trunk);

            // 2. ç²¾è‡´æ ‘å† 
            const leafColors = [0x0b3018, 0x0f4021, 0x14522a, 0x1a6635];
            for(let i=0; i<4; i++) {
                const leaf = new THREE.Mesh(
                    new THREE.ConeGeometry(1.6 - i*0.35, 1.2, 12),
                    new THREE.MeshPhongMaterial({color: leafColors[i], flatShading: true})
                );
                leaf.position.y = 1.0 + (i * 0.8);
                treeGroup.add(leaf);
                
                // åœ¨æ¯ä¸€å±‚å‡è¡¡æŒ‚è½½ç…§ç‰‡
                addPhoto(leaf.position.y, i);
            }
            scene.add(treeGroup);

            // äº¤äº’ç›‘å¬
            window.addEventListener('click', handleAction);
            window.addEventListener('touchstart', (e) => handleAction(e.touches[0]));
        }

        function addPhoto(y, index) {
            const loader = new THREE.TextureLoader();
            // éšæœºç…§ç‰‡å ä½
            const tex = loader.load(`https://picsum.photos/400/500?random=${index + 10}`);
            const geo = new THREE.PlaneGeometry(0.6, 0.8);
            const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
            const photo = new THREE.Mesh(geo, mat);
            
            // èºæ—‹å¼æ’å¸ƒ
            const angle = (index * 2.5);
            const dist = 1.2 - (index * 0.15);
            photo.position.set(Math.cos(angle)*dist, y, Math.sin(angle)*dist);
            photo.lookAt(0, y, 0);
            
            photo.userData = { isPhoto: true, originalPos: photo.position.clone(), originalRot: photo.rotation.clone() };
            treeGroup.add(photo);
        }

        function handleAction(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(treeGroup.children);

            if (intersects.length > 0 && intersects[0].object.userData.isPhoto) {
                const obj = intersects[0].object;
                if(obj.scale.x === 1) {
                    // ç‚¹å‡»æ”¾å¤§ï¼šç¬é—´ç§»åŠ¨åˆ°å±å¹•ä¸­å¤®
                    obj.scale.set(2.5, 2.5, 2.5);
                    obj.position.set(0, 2, 3); 
                    obj.rotation.set(0, 0, 0);
                } else {
                    // ç¼©å›åŸä½
                    obj.scale.set(1, 1, 1);
                    obj.position.copy(obj.userData.originalPos);
                    obj.rotation.copy(obj.userData.originalRot);
                }
            }
        }

        async function start() {
            document.getElementById('overlay').style.display = 'none';
            init3D();
            const video = document.getElementById('input-video');
            const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5});
            
            hands.onResults(res => {
                const canvas = document.getElementById('canvas-ui');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(res.image, 0,0,canvas.width,canvas.height);
                if(res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                    const x = res.multiHandLandmarks[0][8].x;
                    if(lastX !== null) treeGroup.rotation.y += (x - lastX) * 120; // æé€Ÿçµæ•åº¦
                    lastX = x;
                    document.getElementById('status').innerText = "VIRTUAL CONTROL ACTIVE";
                } else {
                    document.getElementById('status').innerText = "WAVING HAND TO ROTATE";
                }
            });
            const cam = new Camera(video, {onFrame: async () => {await hands.send({image: video})}, width: 320, height: 240});
            cam.start();
            render();
        }

        function render() {
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
