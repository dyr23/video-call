<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¨å‹åœ£è¯æ ‘ - äº¤äº’ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #000510; overflow: hidden; touch-action: none; }
        #debug-win { position: absolute; top: 10px; right: 10px; width: 100px; height: 130px; border: 2px solid #00ff00; z-index: 100; border-radius: 8px; overflow: hidden; background: #222; transform: scaleX(-1); }
    </style>
</head>
<body>
    <div id="overlay" class="absolute inset-0 z-[200] flex flex-col items-center justify-center bg-black/80 text-white p-6 text-center">
        <h1 class="text-2xl font-bold mb-4 text-green-400">ğŸ„ åœ£è¯æ ‘äº¤äº’å‡†å¤‡å°±ç»ª</h1>
        <p class="mb-8 text-gray-300">ç”±äºæ‰‹æœºéšç§é™åˆ¶<br>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å¯éš”ç©ºäº’åŠ¨</p>
        <button onclick="startExperience()" class="bg-green-600 hover:bg-green-500 px-10 py-4 rounded-full font-bold text-xl shadow-lg shadow-green-900/50 active:scale-95 transition-all">
            å¼€å¯æ‘„åƒå¤´
        </button>
    </div>

    <div id="status" class="absolute top-10 w-full text-center text-white z-50 text-lg font-medium pointer-events-none"></div>
    <div id="debug-win"><video id="v" style="display:none"></video><canvas id="c" style="width:100%;height:100%"></canvas></div>

    <script>
        let scene, camera, renderer, treeGroup, camInstance;
        let lastX = null;
        
        // --- 1. åˆå§‹åŒ– 3D åœºæ™¯ ---
        function init3D() {
            scene = new THREE.Scene();
            // è°ƒæ•´è§†è§’ï¼šè®©ç›¸æœºç¦»æ ‘æ›´è¿‘ (ä»8é™åˆ°5)
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2.5, 5); 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(5, 10, 5);
            scene.add(sun);

            treeGroup = new THREE.Group();
            // æ•´ä½“æ”¾å¤§æ ‘çš„æ¯”ä¾‹
            treeGroup.scale.set(1.5, 1.5, 1.5); 
            
            // æ ‘å¹²
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.3, 1), new THREE.MeshPhongMaterial({color: 0x5D4037}));
            treeGroup.add(trunk);
            
            // ç²¾è‡´æ ‘å† 
            for(let i=0; i<5; i++) {
                const leaf = new THREE.Mesh(
                    new THREE.ConeGeometry(2 - i*0.35, 1.3, 12),
                    new THREE.MeshPhongMaterial({color: 0x2D5A27, flatShading: true})
                );
                leaf.position.y = 1.0 + (i * 0.8);
                treeGroup.add(leaf);
            }
            scene.add(treeGroup);
        }

        // --- 2. æ‰‹åŠ¿ç®—æ³• ---
        const video = document.getElementById('v');
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d');
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        
        hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6});
        hands.onResults(res => {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(res.image, 0,0,canvas.width,canvas.height);
            if(res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                const x = res.multiHandLandmarks[0][8].x;
                if(lastX !== null) { 
                    // æè‡´çµæ•åº¦ï¼šä¹˜æ•°è°ƒåˆ° 80
                    treeGroup.rotation.y += (x - lastX) * 80; 
                }
                lastX = x;
                document.getElementById('status').innerText = "âœ¨ æ­£åœ¨è·Ÿéšä½ çš„æ‰‹åŠ¿ âœ¨";
            } else {
                lastX = null;
                document.getElementById('status').innerText = "ğŸ™Œ è¯·åœ¨å³ä¸Šè§’æ¡†å†…éœ²å‡ºä½ çš„æ‰‹";
            }
        });

        // --- 3. å¯åŠ¨å‡½æ•° ---
        window.startExperience = async function() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('status').innerText = "æ­£åœ¨æ¿€æ´»æ‘„åƒå¤´...";
            
            try {
                init3D();
                camInstance = new Camera(video, {
                    onFrame: async () => { await hands.send({image: video}); },
                    width: 320, height: 240
                });
                await camInstance.start();
                render();
            } catch (err) {
                alert("æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼Œè¯·ç¡®ä¿ä½¿ç”¨HTTPSè®¿é—®å¹¶å…è®¸æƒé™ï¼");
                console.error(err);
            }
        };

        function render() { requestAnimationFrame(render); renderer.render(scene, camera); }

        window.onresize = () => {
            if(!camera) return;
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
        };
    </script>
</body>
</html>
